name: Deploy Next.js to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install

      - name: Build Next.js
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          script: |
            set -eo pipefail
            
            APP_DIR="/var/www/unitconverterhub"
            SERVICE_NAME="unitconverterhub"
            
            # Create app directory if it doesn't exist
            sudo mkdir -p "$APP_DIR"
            sudo chown -R ${{ secrets.FRONTEND_VPS_USERNAME }}:${{ secrets.FRONTEND_VPS_USERNAME }} "$APP_DIR"
            
            # Stop existing service
            sudo systemctl stop "$SERVICE_NAME" 2>/dev/null || true
            
            echo "ðŸ“¦ Preparing deployment..."
            
      - name: Copy standalone build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          source: ".next/standalone,.next/static,public"
          target: "/var/www/unitconverterhub"
          strip_components: 0

      - name: Copy Caddyfile to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          source: "Caddyfile"
          target: "/tmp"
          strip_components: 0

      - name: Setup systemd service and restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          script: |
            set -eo pipefail
            
            APP_DIR="/var/www/unitconverterhub"
            SERVICE_NAME="unitconverterhub"
            
            # Ensure proper permissions
            sudo chown -R ${{ secrets.FRONTEND_VPS_USERNAME }}:${{ secrets.FRONTEND_VPS_USERNAME }} "$APP_DIR"
            
            # Ensure .next/static symlink exists (created during build)
            if [ ! -L "$APP_DIR/.next/standalone/.next/static" ] && [ -d "$APP_DIR/.next/static" ]; then
              sudo ln -sf "$APP_DIR/.next/static" "$APP_DIR/.next/standalone/.next/static" || true
            fi
            
            # Copy Caddyfile to /etc/caddy/Caddyfile
            if [ -f /tmp/Caddyfile ]; then
              # Ensure /etc/caddy directory exists
              sudo mkdir -p /etc/caddy
              sudo cp /tmp/Caddyfile /etc/caddy/Caddyfile
              sudo chown root:root /etc/caddy/Caddyfile
              sudo chmod 644 /etc/caddy/Caddyfile
              
              # Try to reload Caddy if available
              if command -v caddy >/dev/null 2>&1; then
                sudo caddy reload --config /etc/caddy/Caddyfile || sudo caddy reload || true
                echo "âœ… Caddyfile updated and Caddy reloaded"
              elif [ -f /usr/bin/caddy ]; then
                sudo /usr/bin/caddy reload --config /etc/caddy/Caddyfile || sudo /usr/bin/caddy reload || true
                echo "âœ… Caddyfile updated and Caddy reloaded"
              elif [ -f /usr/local/bin/caddy ]; then
                sudo /usr/local/bin/caddy reload --config /etc/caddy/Caddyfile || sudo /usr/local/bin/caddy reload || true
                echo "âœ… Caddyfile updated and Caddy reloaded"
              else
                echo "âš ï¸  Caddyfile copied but Caddy not found - please install Caddy or reload manually"
              fi
            fi
            
            # Create systemd service file
            sudo tee /etc/systemd/system/"$SERVICE_NAME".service > /dev/null <<EOF
            [Unit]
            Description=Unit Converter Hub Next.js App
            After=network.target

            [Service]
            Type=simple
            User=${{ secrets.FRONTEND_VPS_USERNAME }}
            WorkingDirectory=$APP_DIR/.next/standalone
            ExecStart=/usr/bin/node $APP_DIR/.next/standalone/server.js
            Restart=always
            RestartSec=10
            Environment=NODE_ENV=production
            Environment=PORT=3000

            [Install]
            WantedBy=multi-user.target
            EOF
            
            # Reload systemd and start service
            sudo systemctl daemon-reload
            sudo systemctl enable "$SERVICE_NAME"
            sudo systemctl restart "$SERVICE_NAME"
            
            # Verify service is running
            sleep 3
            sudo systemctl status "$SERVICE_NAME" --no-pager || exit 1
            
            echo "âœ… Next.js app deployed and running!"
            echo "âœ… Caddy configuration updated"
