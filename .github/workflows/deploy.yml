name: Deploy Next.js (Admin + API) to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install
        working-directory: unit

      - name: Clean Next.js cache
        run: rm -rf .next
        working-directory: unit

      - name: Build Next.js
        run: pnpm build
        working-directory: unit
        env:
          NODE_ENV: production

      - name: Create DB directory and prepare deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          script: |
            set -eo pipefail
            APP_DIR="/var/www/calculinohub"
            DB_DIR="/var/www/db-calculino"
            SERVICE_NAME="calculinohub"

            sudo mkdir -p "$APP_DIR" "$DB_DIR"
            sudo chown -R ${{ secrets.FRONTEND_VPS_USERNAME }}:${{ secrets.FRONTEND_VPS_USERNAME }} "$APP_DIR" "$DB_DIR"

            pm2 stop "$SERVICE_NAME" 2>/dev/null || true
            pm2 delete "$SERVICE_NAME" 2>/dev/null || true
            pm2 stop unitconverterhub 2>/dev/null || true
            pm2 delete unitconverterhub 2>/dev/null || true

            echo "üì¶ DB directory ready at $DB_DIR"
            echo "üì¶ App directory ready at $APP_DIR"

      - name: Copy app files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          source: "unit/.next/standalone,unit/.next/static,unit/public,unit/ecosystem.config.js,unit/package.json,unit/prisma"
          target: "/var/www/calculinohub"
          strip_components: 1

      - name: Copy Caddyfile to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          source: "unit/Caddyfile"
          target: "/tmp"

      - name: Setup .env, run migrations, and start app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_VPS_HOST }}
          username: ${{ secrets.FRONTEND_VPS_USERNAME }}
          key: ${{ secrets.FRONTEND_VPS_SSH_KEY }}
          script: |
            set -eo pipefail
            APP_DIR="/var/www/calculinohub"
            DB_DIR="/var/www/db-calculino"
            DB_PATH="$DB_DIR/dev.db"
            SERVICE_NAME="calculinohub"

            sudo chown -R ${{ secrets.FRONTEND_VPS_USERNAME }}:${{ secrets.FRONTEND_VPS_USERNAME }} "$APP_DIR"

            # Verify server.js
            if [ ! -f "$APP_DIR/.next/standalone/server.js" ]; then
              echo "‚ùå server.js not found"
              ls -la "$APP_DIR/.next/standalone/" || true
              exit 1
            fi

            # Symlink .next/static if needed
            if [ ! -L "$APP_DIR/.next/standalone/.next/static" ] && [ -d "$APP_DIR/.next/static" ]; then
              ln -sf "$APP_DIR/.next/static" "$APP_DIR/.next/standalone/.next/static" 2>/dev/null || true
            fi

            # Create/update .env for production (DB in /var/www/db-calculino)
            ENV_FILE="$APP_DIR/.env"
            if [ ! -f "$ENV_FILE" ]; then
              {
                echo 'DATABASE_URL="file:'"$DB_PATH"'"'
                [ -n "${{ secrets.ADMIN_SESSION_SECRET }}" ] && echo 'ADMIN_SESSION_SECRET='"${{ secrets.ADMIN_SESSION_SECRET }}"
                [ -n "${{ secrets.OLLAMA_API_KEY }}" ] && echo 'OLLAMA_API_KEY='"${{ secrets.OLLAMA_API_KEY }}"
              } > "$ENV_FILE"
            else
              # Update DATABASE_URL only, preserve other vars
              grep -v '^DATABASE_URL=' "$ENV_FILE" > "${ENV_FILE}.bak" 2>/dev/null || true
              echo 'DATABASE_URL="file:'"$DB_PATH"'"' >> "${ENV_FILE}.bak"
              mv "${ENV_FILE}.bak" "$ENV_FILE"
            fi

            # Prisma migrate & seed (DB in /var/www/db-calculino)
            cd "$APP_DIR"
            export DATABASE_URL="file:$DB_PATH"
            if [ -d prisma ]; then
              npx prisma migrate deploy
              npx prisma db seed 2>/dev/null || echo "‚ö†Ô∏è Seed skipped (run manually if needed)"
            fi

            # Caddy
            if [ -f /tmp/Caddyfile ]; then
              sudo mkdir -p /etc/caddy
              sudo cp /tmp/Caddyfile /etc/caddy/Caddyfile
              sudo chown root:root /etc/caddy/Caddyfile
              command -v caddy >/dev/null 2>&1 && sudo caddy reload --config /etc/caddy/Caddyfile 2>/dev/null || true
            fi

            mkdir -p "$APP_DIR/logs"

            # PM2
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi
            cd "$APP_DIR"
            pm2 start ecosystem.config.js --update-env
            pm2 save
            pm2 startup systemd -u ${{ secrets.FRONTEND_VPS_USERNAME }} --hp /home/${{ secrets.FRONTEND_VPS_USERNAME }} 2>/dev/null || true

            sleep 3
            pm2 status || true
            curl -f http://localhost:3000 >/dev/null 2>&1 && echo "‚úÖ App OK" || echo "‚ö†Ô∏è App not responding yet"

            echo "‚úÖ Deploy complete. DB: $DB_PATH"
