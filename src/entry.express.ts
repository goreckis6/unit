import express from 'express';
import { createQwikCity } from '@builder.io/qwik-city/middleware/node';
import { render } from './entry.ssr';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { readdir, access, constants } from 'fs/promises';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const app = express();

// Import qwikCityPlan - it should be generated by qwikCity() plugin
import qwikCityPlan from '@qwik-city-plan';

// Path to dist directory containing static files
// entry.express.js is in dist/, so distDir is __dirname
const distDir = __dirname;

console.log('ğŸ“ Dist directory:', distDir);

// Check build directory asynchronously
(async () => {
  try {
    await access(join(distDir, 'build'), constants.F_OK);
    const buildFiles = await readdir(join(distDir, 'build'));
    console.log('âœ… Build directory exists with', buildFiles.length, 'files');
    console.log('ğŸ“ Sample files:', buildFiles.slice(0, 5));
    try {
      await access(join(distDir, 'build', 'preloader.js'), constants.F_OK);
      console.log('âœ… preloader.js exists');
    } catch {
      console.log('âŒ preloader.js NOT found');
    }
  } catch {
    console.log('âŒ Build directory NOT found');
  }
})();

// Error handling middleware
app.use((err, req, res, next) => {
  console.error('âŒ Error serving:', req.path, err.message);
  if (!res.headersSent) {
    res.status(500).send('Internal Server Error');
  }
});

const { router, notFound, staticFile } = createQwikCity({
  render,
  qwikCityPlan,
  static: {
    root: distDir,
    cacheControl: 'public, max-age=31536000, immutable'
  }
});

// Log all requests for debugging
app.use((req, res, next) => {
  if (req.path.startsWith('/build/') || req.path.startsWith('/assets/')) {
    console.log('ğŸ“¦ Request for static file:', req.path);
  }
  next();
});

// Use Express static middleware first for build/ and assets/ files
app.use(express.static(distDir, {
  maxAge: '1y',
  immutable: true
}));

// Then use Qwik City staticFile middleware
app.use(staticFile);

// Then handle Qwik routes
app.use(router);

// Finally handle 404
app.use(notFound);

app.listen(3000, '0.0.0.0', () => {
  console.log('âœ… Qwik SSR running on http://0.0.0.0:3000');
  console.log('ğŸ“ Serving static files from:', distDir);
});
